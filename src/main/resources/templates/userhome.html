<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="header::head-fragment(~{::title})">
    <title th:text="'MediRec | '+ ${session.loginUser.username} + '的用户主页'"></title>
</head>
<body>

<nav th:replace="header::nav-fragment"></nav>

<section class="slice py-7">
    <div class="container">
        <div class="row min-vh-100">
            <div class="col-2">
                <div class="list-group align-items-center" id="list-tab" role="tablist">
                    <a aria-controls="home" class="list-group-item list-group-item-action active" data-toggle="list"
                       href="#list-home" id="list-home-list" role="tab">我的主页</a>
                    <a aria-controls="profile" class="list-group-item list-group-item-action" data-toggle="list"
                       href="#list-profile" id="list-profile-list" role="tab">我的资料</a>
                    <a aria-controls="profile" class="list-group-item list-group-item-action" data-toggle="list"
                       href="#list-records" id="list-records-list" role="tab">上传记录</a>
                    <a aria-controls="messages" class="list-group-item list-group-item-action" data-toggle="list"
                       href="#list-settings" id="list-settings-list" role="tab">修改资料</a>
                    <a aria-controls="settings" class="list-group-item list-group-item-action" data-toggle="list"
                       href="#list-password-reset" id="list-password-reset-list" role="tab">修改密码</a>
                </div>
            </div>
            <div class="col-10">
                <div class="tab-content" id="nav-tabContent">
                    <!-- 我的主页 -->
                    <div aria-labelledby="list-home-list" class="tab-pane fade show active" id="list-home"
                         role="tabpanel">
                        <h2>我的主页</h2>
                        <div th:if="${session.uploadedImage == null}">
                            <h3>上传图片</h3>
                            <p>
                                从本地选择一张需要重建的CT图像，可以是保存为.npy格式的正弦图或者DICOM、jpg格式的稀疏视角重建得到的带有伪影的图像。
                            </p>

                            <div class="container">
                                <div class="row justify-content-start">
                                    <div class="col-10">
                                        <form enctype="multipart/form-data"
                                              id="imgUploadForm" method="post">
                                            <!--                                            <input type="hidden" name="userId" th:value="${session.loginUser.id}">-->
                                            <label class="form-control-label">选择图片</label>
                                            <div class="input-group mb-3">
                                                <div class="custom-file">
                                                    <input aria-describedby="inputGroupFileAddon01"
                                                           class="custom-file-input" id="inputFile"
                                                           name="file" type="file">
                                                    <label class="custom-file-label" for="inputFile"></label>
                                                </div>
                                            </div>
                                            <fieldset class="form-group">
                                                <div class="row">
                                                    <div class="col-sm-10">
                                                        <div>
                                                            <label class="form-control-label">选择图片类型</label>
                                                        </div>
                                                        <div>
                                                            <div class="form-check">
                                                                <input checked class="form-check-input"
                                                                       id="gridRadios1" name="sinogram"
                                                                       type="radio"
                                                                       value="true">
                                                                <label class="form-check-label" for="gridRadios1">
                                                                    正弦图
                                                                </label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" id="gridRadios2"
                                                                       name="sinogram" type="radio"
                                                                       value="false">
                                                                <label class="form-check-label" for="gridRadios2">
                                                                    非正弦图
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </fieldset>
                                            <div class="row justify-content-center">
                                                <div class="mt-4 col-4 ">
                                                    <button class="btn btn-block btn-primary" id="uploadButton"
                                                            type="button">
                                                        上传图片并重建
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${session.uploadedImage != null}">
                            <h3>重建效果</h3>
                            <p th:text="${session.uploadedImage}"></p>
                            <div class="container">
                                <div class="row justify-content-around">
                                    <div class="col-5">
                                        <h4>输入图片：</h4>
                                        <img alt="无图片" th:src="${session.uploadedImage.demoUrl}" width="100%">
                                    </div>
                                    <div class="col-5">
                                        <h4>输出图片：</h4>
                                        <img alt="无图片" th:src="${session.uploadedImage.demoUrl}" width="100%">
                                    </div>
                                </div>
                                <div class="row justify-content-center">
                                    <div class="mt-4 col-4 ">
                                        <form>
                                            <button class="btn btn-block btn-primary" id="restoreButton"
                                                    type="button">
                                                重新上传
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                    <!-- 我的资料 -->
                    <div aria-labelledby="list-profile-list" class="tab-pane fade" id="list-profile" role="tabpanel">
                        profile
                    </div>
                    <!-- 上传记录 -->
                    <div aria-labelledby="list-records-list" class="tab-pane fade" id="list-records" role="tabpanel">
                        records
                    </div>
                    <!-- 修改资料 -->
                    <div aria-labelledby="list-settings-list" class="tab-pane fade" id="list-settings" role="tabpanel">
                        settings
                    </div>
                    <!-- 修改密码 -->
                    <div aria-labelledby="list-password-reset-list" class="tab-pane fade" id="list-password-reset"
                         role="tabpanel">
                        password reset
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<footer th:replace="footer::footer-fragment"></footer>
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/svg-injector.min.js"></script>
<script src="/js/feather.min.js"></script>
<script src="/js/quick-website.js"></script>
<script>
    $('#list-tab a').on('click', function (e) {
        e.preventDefault()
        $(this).tab('show')
    })
    // var data = $("#imgUploadForm").serialize()

    $('#uploadButton').on('click', function () {
        // var formData = new FormData($('#imgUploadForm'));
        var files = $('#inputFile').prop('files');
        var sinogram;
        var obj = document.getElementsByName('sinogram');
        for (i = 0; i < obj.length; i++) {
            if (obj[i].checked) {
                sinogram = obj[i].value;
                break;
            }
        }

        var formData = new FormData();
        formData.append('file', files[0]);
        formData.append('sinogram', sinogram);

        $.ajax({
            type: "POST",
            url: "/image/uploadAndReconstructImage",
            data: formData,
            processData: false,
            contentType: false,
            success: function (res) {
                if (res.data == null) {
                    alert("图片上传失败");
                } else {
                    alert("图片上传成功！");
                    window.location = "/user/home";
                }
            }
        })
    })

    $('#restoreButton').on('click', function () {
        $.ajax({
            type: "GET",
            url: "/image/restore",
            data: null,
            success: function (res) {
                window.location = "/user/home";
            }
        })
    })
</script>
</body>
</html>